name: Agent Swarm Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # Build Synapse from source with full features
  build-synapse:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          repository: pmaojo/synapse-engine
          path: synapse-engine
          
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        
      - name: Build with all features
        run: |
          cd synapse-engine/crates/synapse-core
          cargo build --release --features local-embeddings
          
      - name: Create package
        run: |
          mkdir -p dist
          cp synapse-engine/target/release/synapse dist/
          
          # Download embeddings model for offline use
          mkdir -p models
          python3 -c "
from fastembed import InitOptions, TextEmbedding, EmbeddingModel
import os
print('ðŸ“¥ Downloading embedding model (BGE-small-ENV15)...')
model = TextEmbedding(InitOptions(EmbeddingModel.BGESmallENV15))
print('âœ… Model downloaded!')
cache_dir = os.path.expanduser('~/.cache/fastembed')
print(f'Model cached at: {cache_dir}')
"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: synapse-full
          path: |
            dist/synapse
            ~/.cache/fastembed/

  # Test with Synapse
  test:
    runs-on: ubuntu-latest
    needs: build-synapse
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: synapse-full
          
      - name: Setup
        run: |
          chmod +x dist/synapse
          mkdir -p data
          
          # Restore model cache
          if [ -d "fastembed" ]; then
            cp -r fastembed ~/.cache/
          fi
          
      - name: Test Synapse
        run: |
          # Start Synapse in background
          GRAPH_STORAGE_PATH=./data ./dist/synapse --mcp &
          sleep 5
          
          # Test with Python SDK
          pip install synapse-sdk
          python3 -c "
from synapse import get_client
client = get_client()

# Test ingest
client.ingest_triples([
    {'subject': 'test', 'predicate': 'works', 'object': 'yes'}
])
print('âœ… Ingest OK!')

# Test query
results = client.get_all_triples()
print(f'âœ… Query OK! Found {len(results)} triples')
print('ðŸŽ‰ Synapse is fully working!')
"
