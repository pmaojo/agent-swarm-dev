name: Agent Swarm Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # Build Synapse from crates.io with full features
  build-synapse:
    runs-on: ubuntu-24.04
    steps:
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        
      - name: Install Synapse Core v0.8.5
        run: |
          cargo install synapse-core --version 0.8.5
          
      - name: Create package
        run: |
          mkdir -p dist
          cp ~/.cargo/bin/synapse dist/
          
          # Download embeddings model
          python3 -c "
from fastembed import InitOptions, TextEmbedding, EmbeddingModel
print('ðŸ“¥ Downloading BGE-small-ENV15...')
model = TextEmbedding(InitOptions(EmbeddingModel.BGESmallENV15))
print('âœ… Model ready!')
"
          
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: synapse-v085
          path: |
            dist/synapse
            ~/.cache/fastembed/

  # Test
  test:
    runs-on: ubuntu-latest
    needs: build-synapse
    steps:
      - name: Download
        uses: actions/download-artifact@v4
        with:
          name: synapse-v085
          
      - name: Setup
        run: |
          chmod +x dist/synapse
          cp -r fastembed ~/.cache/ 2>/dev/null || true
          mkdir -p data
          
      - name: Test Synapse
        run: |
          GRAPH_STORAGE_PATH=./data ./dist/synapse --mcp &
          sleep 5
          
          pip install synapse-sdk
          python3 -c "
from synapse import get_client
client = get_client()
client.ingest_triples([{'subject': 'test', 'predicate': 'works', 'object': 'yes'}])
print('âœ… Synapse v0.8.5 working!')
"
