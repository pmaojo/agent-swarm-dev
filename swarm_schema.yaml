schema_version: "1.3"

memory_settings:
  consolidation_threshold: 5

agents:
  Orchestrator:
    description: "Coordinates task flow and manages state using graph-based reasoning."
    ontology_role: "Program Manager"
    supported_stacks: []
  ProductManager:
    description: "Transforms user ideas into structured OpenSpec requirements."
    ontology_role: "Product Manager"
    supported_stacks: ["openspec", "markdown"]
  Architect:
    description: "Designs technical solutions and implementation plans based on OpenSpec."
    ontology_role: "System Architect"
    supported_stacks: ["openspec", "markdown"]
  Coder:
    description: "Implements features and writes code based on specifications and feedback."
    ontology_role: "Frontend Developer"
    supported_stacks: ["python", "react", "rust", "typescript"]
  Reviewer:
    description: "Reviews code for quality, security, and spec adherence using static analysis and LLM reasoning."
    ontology_role: "QA Engineer"
    supported_stacks: ["python", "react", "rust", "typescript"]
  Deployer:
    description: "Verifies and deploys the application."
    ontology_role: "DevOps Engineer"
    supported_stacks: ["vercel", "docker"]

tasks:
  RequirementsDefinitionTask:
    handler: ProductManager
    description: "Define requirements in OpenSpec format."
    outputs: ["OpenSpecDocument"]
    required_permissions: ["RequirementsDefinitionPermission"]
    current_stack: "openspec"
  SystemDesignTask:
    handler: Architect
    description: "Create technical design and task breakdown."
    inputs: ["OpenSpecDocument"]
    outputs: ["DesignDocument", "TaskChecklist"]
    required_permissions: ["SystemDesignPermission"]
    current_stack: "openspec"
  FeatureImplementationTask:
    handler: Coder
    description: "Implement a feature based on a specification."
    outputs: ["CodeArtifact"]
    required_permissions: ["CodeGenerationPermission"]
    current_stack: "python" # Default, overridden at runtime
  CodeReviewTask:
    handler: Reviewer
    description: "Review the implemented code."
    inputs: ["CodeArtifact"]
    outputs: ["ReviewCritique", "LintError"]
    required_permissions: ["CodeReviewPermission"]
    current_stack: "python"
  DeploymentTask:
    handler: Deployer
    description: "Deploy the verified code."
    inputs: ["CodeArtifact"]
    outputs: ["DeploymentResult"]
    required_permissions: ["DeploymentPermission"]
    current_stack: "vercel"

transitions:
  # PM & Architect handled via Trello Event Loop, but defined here for ontology completeness
  RequirementsDefinitionTask:
    on_success: SystemDesignTask
    on_failure: RequirementsDefinitionTask
  SystemDesignTask:
    on_success: FeatureImplementationTask # Gated by [APPROVED] label in logic
    on_failure: RequirementsDefinitionTask

  FeatureImplementationTask:
    on_success: CodeReviewTask
    on_failure: FeatureImplementationTask

  CodeReviewTask:
    on_success: DeploymentTask
    on_failure: FeatureImplementationTask

  DeploymentTask:
    on_success: null
    on_failure: DeploymentTask

artifacts:
  OpenSpecDocument:
    description: "Structured requirements file in OpenSpec format."
    properties:
      - path
      - content_hash
  DesignDocument:
    description: "Technical design document."
    properties:
      - path
  TaskChecklist:
    description: "List of implementation tasks."
    properties:
      - tasks
  CodeArtifact:
    description: "Source code file generated by Coder."
    properties:
      - path
      - language
      - content_hash
  ReviewCritique:
    description: "Feedback from Reviewer explaining why code was rejected."
    properties:
      - severity
      - message
      - file_path
      - line_number
  LintError:
    description: "Static analysis error found by tools like pylint/flake8."
    properties:
      - tool
      - code
      - message
      - line
  TestResult:
    description: "Result of a test execution."
    properties:
      - passed
      - output
  DeploymentResult:
    description: "Result of a deployment attempt."
    properties:
      - url
      - status
